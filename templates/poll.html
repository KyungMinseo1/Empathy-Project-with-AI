{% extends "base.html" %}

{% block title %}투표: {{ poll.question }}{% endblock %}

{% block content %}
<div class="mb-4">
  <a href="{{ url_for('classroom_view', classroom_id=classroom.id) }}" class="btn btn-secondary">
    ← 클래스룸으로
  </a>
</div>

<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">{{ poll.question }}</h5>
  </div>
  <div class="card-body">
    {% if current_user.role == "student" and poll.is_active %}
      <!-- 학생 투표 폼 -->
      <form id="voteForm" method="POST" action="{{ url_for('submit_vote', poll_id=poll.id) }}">
        <div class="mb-3">
          <div class="form-check mb-2">
            <label class="form-label">나는 어떻게 행동해야 할까요?</label>
            {% for i in range(options|length) %}
              <input class="form-check-input" type="radio" name="option" id="option{{ i }}" 
                    value="{{ i }}" required
                    {% if existing_vote and existing_vote.option_index == i %}checked{% endif %}>
              <label class="form-check-label fs-6" for="option{{ i }}">
                {{ options[i] }}
              </label>
            {% endfor %}
          </div>
          <div class="form-check mb-2">
            <label class="form-label">왜 그렇게 생각했나요?</label>
            <textarea class="form-control" name="evidence" id="evidence" rows="3" required>
              {{ existing_vote.evidence if existing_vote else '' }}
            </textarea>
          </div>
          <div class="form-check mb-2">
            <label class="form-label">AI 친구에게 해주고 싶은 말은 무엇인가요?</label>
            <textarea class="form-control" name="ai_opinion" id="ai_opinion" rows="3" required>
              {{ existing_vote.ai_opinion if existing_vote else '' }}
            </textarea>
          </div>
        </div>
        
        {% if existing_vote %}
          <button type="submit" class="btn btn-warning btn-md">투표 변경하기</button>
          <span class="text-muted ms-2">현재 투표: {{ options[existing_vote.option_index] }}</span>
        {% else %}
          <button type="submit" class="btn btn-success btn-md">투표하기</button>
        {% endif %}
      </form>
    {% elif not poll.is_active %}
      <div class="alert alert-secondary">
        이 투표는 종료되었습니다.
      </div>
    {% endif %}
  </div>
</div>

<!-- 투표 결과 -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">실시간 투표 결과</h5>
  </div>
  <div class="card-body" id="resultsContainer">
    {% if results %}
      {% for i in range(options|length) %}
      <div class="mb-3">
        <div class="d-flex justify-content-between mb-1">
          <span><strong>{{ options[i] }}</strong></span>
          <span class="badge bg-primary" id="count-{{ i }}">
            {{ results.get(i, 0) }}표
          </span>
        </div>
        
        {% set total = results.values()|sum %}
        {% set count = results.get(i, 0) %}
        {% set percentage = (count / total * 100) if total > 0 else 0 %}
        
        <div class="progress" style="height: 30px;">
          <div class="progress-bar" role="progressbar" 
               style="width: {{ percentage }}%"
               id="bar-{{ i }}">
            {{ "%.1f"|format(percentage) }}%
          </div>
        </div>
        
        <!-- 교수자만 투표자 명단 확인 -->
        {% if current_user.role == "professor" and voters.get(i) %}
        <small class="text-muted" id="voters-{{ i }}">
          투표자: {{ voters[i]|join(', ') }}
        </small>
        {% endif %}
      </div>
      {% endfor %}
      
      <div class="alert alert-info mt-3">
        <strong>총 투표 수:</strong> <span id="totalVotes">{{ results.values()|sum }}</span>명
      </div>
    {% else %}
      <p class="text-muted">아직 투표가 없습니다.</p>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">선택 이유</h5>
  </div>
  <div class="card-body" id="evidencesContainer">
    {% if evidences %}
      <div class="row">
        {% for key, value in evidences.items() %}
          <div class="col-12 col-md-4 mb-3">
            <div class="p-3 border rounded">
              <div class="p-2 border rounded mb-2">
                <strong>{{ key }}</strong><br>
                <span>{{ value }}</span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h5 class="mb-0">AI 친구에게 한마디</h5>
  </div>
  <div class="card-body" id="opinionssContainer">
    {% if opinions %}
      <div class="row">
        {% for key, value in opinions.items() %}
          <div class="col-12 col-md-4 mb-3">
            <div class="p-3 border rounded">
              <div class="p-2 border rounded mb-2">
                <strong>{{ key }}</strong><br>
                <span>{{ value }}</span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  let isFormActive = false;

  document.addEventListener("DOMContentLoaded", () => {
    // 클래스룸 입장
    socket.emit('join', {classroom_id: {{ classroom.id }}});
    
    // 실시간 투표 업데이트
    socket.on('vote_update', function(data) {
      if (parseInt(data.poll_id) === {{ poll.id }}) {
        if (!isFormActive) { 
          console.log("투표 업데이트 수신, 새로고침 실행.");
          location.reload();
        } else {
          console.log("폼 작성 중이므로 새로고침 방지.");
        }
      }
    });

    socket.on('connect_error', function(error) {
      console.error('소켓 연결 오류:', error);
    });

    // 투표 폼 처리
    const voteForm = document.getElementById('voteForm');

    if (voteForm) {
      const formControls = voteForm.querySelectorAll('input, textarea');
      
      formControls.forEach(control => {
        control.addEventListener('focus', () => {
          isFormActive = true;
        });
        
        // blur 이벤트 추가: 포커스를 잃었을 때
        control.addEventListener('blur', () => {
          // 짧은 지연 후 다른 폼 요소에 포커스가 없으면 비활성화
          setTimeout(() => {
            if (!voteForm.contains(document.activeElement)) {
              isFormActive = false;
            }
          }, 100);
        });
      });
      
      voteForm.addEventListener('submit', () => {
        isFormActive = false; 
      });
    }

    // 카드 색상 지정 (실제 존재하는 클래스/요소로 수정 필요)
    const cards = document.querySelectorAll(".p-3.border.rounded");

    const colors = [
      "#FFEBEE", "#FFF3E0", "#FFFDE7",
      "#E8F5E9", "#E3F2FD", "#EDE7F6"
    ];

    cards.forEach(card => {
      const strongElement = card.querySelector("strong");
      if (!strongElement) return; // 안전성 체크
      
      const key = strongElement.innerText;

      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        hash = key.charCodeAt(i) + ((hash << 5) - hash);
      }
      const index = Math.abs(hash) % colors.length;

      card.style.backgroundColor = colors[index];
    });
  });
</script>
{% endblock %}