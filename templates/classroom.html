{% extends "base.html" %}

{% block title %}{{ classroom.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2>ğŸ“š {{ classroom.name }}</h2>
    <p class="text-muted mb-0">
      í´ë˜ìŠ¤ë£¸ ì½”ë“œ: <span class="badge bg-success">{{ classroom.code }}</span>
    </p>
  </div>
  <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ</a>
</div>

{% if current_user.role == "professor" %}
  <!-- íˆ¬í‘œ ìƒì„± í¼ (êµìˆ˜ìë§Œ) -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">ìƒˆ íˆ¬í‘œ ë§Œë“¤ê¸°</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('create_poll', classroom_id=classroom.id) }}" id="pollForm">
        <div class="mb-3">
          <label for="question" class="form-label">ì§ˆë¬¸</label>
          <input type="text" class="form-control" id="question" name="question" required
                 placeholder="í•™ìƒë“¤ì—ê²Œ ë¬¼ì–´ë³¼ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        
        <div class="mb-3">
          <label class="form-label">ì„ íƒì§€</label>
          <div id="optionsContainer">
            <div class="input-group mb-2">
              <span class="input-group-text">1</span>
              <input type="text" class="form-control" name="options[]" required placeholder="ì²« ë²ˆì§¸ ì„ íƒì§€">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text">2</span>
              <input type="text" class="form-control" name="options[]" required placeholder="ë‘ ë²ˆì§¸ ì„ íƒì§€">
            </div>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="addOption">
            + ì„ íƒì§€ ì¶”ê°€
          </button>
        </div>
        
        <button type="submit" class="btn btn-primary">íˆ¬í‘œ ìƒì„±</button>
      </form>
    </div>
  </div>
{% endif %}

<!-- íˆ¬í‘œ ëª©ë¡ -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">íˆ¬í‘œ ëª©ë¡</h5>
  </div>
  <div class="card-body">
    {% if polls %}
      <div class="list-group" id="pollsList">
        {% for poll in polls %}
        <a href="{{ url_for('poll_view', poll_id=poll.id) }}" 
           class="list-group-item list-group-item-action">
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1">{{ poll.question }}</h6>
            <small class="text-muted">{{ poll.created_at.strftime('%m/%d %H:%M') }}</small>
          </div>
          {% if poll.is_active %}
            <span class="badge bg-success">ì§„í–‰ì¤‘</span>
          {% else %}
            <span class="badge bg-secondary">ì¢…ë£Œë¨</span>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">ì•„ì§ ìƒì„±ëœ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  
  // í´ë˜ìŠ¤ë£¸ ì…ì¥
  socket.emit('join', {classroom_id: {{ classroom.id }}});
  
  // ìƒˆ íˆ¬í‘œ ì•Œë¦¼
  socket.on('new_poll', function(data) {
    location.reload(); // ê°„ë‹¨í•˜ê²Œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
  });
  
  // ì„ íƒì§€ ì¶”ê°€ ê¸°ëŠ¥
  {% if current_user.role == "professor" %}
  let optionCount = 2;
  document.getElementById('addOption').addEventListener('click', function() {
    optionCount++;
    const container = document.getElementById('optionsContainer');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
      <span class="input-group-text">${optionCount}</span>
      <input type="text" class="form-control" name="options[]" required placeholder="${optionCount}ë²ˆì§¸ ì„ íƒì§€">
      <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Ã—</button>
    `;
    container.appendChild(div);
  });
  {% endif %}
</script>
{% endblock %}