{% extends "base.html" %}

{% block title %}{{ classroom.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>ğŸ“š {{ classroom.name }}</h2>
        <p class="text-muted mb-0">
            í´ë˜ìŠ¤ë£¸ ì½”ë“œ: <span class="badge bg-success">{{ classroom.code }}</span>
        </p>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ</a>
</div>

{% if current_user.role == "professor" %}
<!-- íˆ¬í‘œ ìƒì„± í¼ (êµìˆ˜ìë§Œ) -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">ìƒˆ íˆ¬í‘œ ë§Œë“¤ê¸°</h5>
    </div>
    <div class="card-body">
        <!-- onsubmit ì´ë²¤íŠ¸ ì¶”ê°€ -->
        <form method="POST" action="{{ url_for('create_poll', classroom_id=classroom.id) }}" id="pollForm" onsubmit="return validateForm(event);">
            <!-- Flexbox ì»¨í…Œì´ë„ˆ: ì¢Œìš° ë¶„í•  ì‹œì‘ -->
            <div class="d-flex flex-column flex-md-row">
                
                <!-- ì™¼ìª½ ì„¹ì…˜: ìˆ˜ë™ ì…ë ¥ ë° AI ê²°ê³¼ ì±„ìš°ê¸° -->
                <div class="flex-grow-1 me-md-3 mb-3 mb-md-0">
                    <h6>ğŸ“Œ íˆ¬í‘œ ë‚´ìš©</h6>
                    <hr>
                    <div class="mb-3">
                        <label for="question" class="form-label">ì§ˆë¬¸</label>
                        <input type="text" class="form-control" id="question" name="question" 
                               placeholder="í•™ìƒë“¤ì—ê²Œ ë¬¼ì–´ë³¼ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
                               value="{{ initial_question if initial_question is defined and initial_question else '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">ì„ íƒì§€</label>
                        <div id="optionsContainer">
                            {% if initial_options is defined and initial_options %}
                                <!-- AIê°€ ìƒì„±í•œ ì„ íƒì§€ë¡œ ë™ì  ì±„ìš°ê¸° -->
                                {% for option in initial_options %}
                                    <div class="input-group mb-2 option-group">
                                        <span class="input-group-text">{{ loop.index }}</span>
                                        <input type="text" class="form-control" name="options[]" 
                                               value="{{ option }}" placeholder="ì„ íƒì§€ {{ loop.index }}">
                                        {% if loop.index > 2 %}
                                            <!-- AI ìƒì„± ì‹œ 3ë²ˆì§¸ ì˜µì…˜ë¶€í„°ëŠ” ì œê±° ë²„íŠ¼ í‘œì‹œ -->
                                            <button type="button" class="btn btn-outline-danger remove-option" onclick="removeOption(this)">X</button>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <!-- ê¸°ë³¸ ì„ íƒì§€ 2ê°œ -->
                                <div class="input-group mb-2 option-group">
                                    <span class="input-group-text">1</span>
                                    <input type="text" class="form-control" name="options[]" placeholder="ì²« ë²ˆì§¸ ì„ íƒì§€">
                                </div>
                                <div class="input-group mb-2 option-group">
                                    <span class="input-group-text">2</span>
                                    <input type="text" class="form-control" name="options[]" placeholder="ë‘ ë²ˆì§¸ ì„ íƒì§€">
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="addOption">
                            + ì„ íƒì§€ ì¶”ê°€
                        </button>
                    </div>
                    
                    <!-- ìµœì¢… ì œì¶œ ë²„íŠ¼ (AI ìƒì„± í›„ì—ë„ ì´ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥í•´ì•¼ í•¨) -->
                    <button type="submit" name="action_type" value="final" class="btn btn-primary w-100 mt-3" id="finalSubmitBtn">íˆ¬í‘œ ìµœì¢… ì œì¶œ</button>
                </div>

                <!-- ì˜¤ë¥¸ìª½ ì„¹ì…˜: AI ìƒì„± ë„êµ¬ -->
                <div class="flex-grow-1 ms-md-3 border-start ps-md-3">
                    <h6>ğŸ¤– AI ìƒì„± ë„êµ¬</h6>
                    <hr>
                    <div class="mb-3">
                        <label for="topic" class="form-label">ì£¼ì œ ì…ë ¥</label>
                        <input type="text" class="form-control" id="topic" name="topic"
                               placeholder="ì˜ˆ: í•™êµ í­ë ¥, í™˜ê²½ ì˜¤ì—¼">
                    </div>
                    <!-- AI ìƒì„± ìš”ì²­ ë²„íŠ¼ -->
                    <button type="submit" name="action_type" value="create" class="btn btn-success w-100" id="aiCreateBtn">ğŸª„ AIë¡œ íˆ¬í‘œ ì´ˆì•ˆ ìƒì„±</button>
                </div>
            </div>
            <!-- Flexbox ì»¨í…Œì´ë„ˆ: ì¢Œìš° ë¶„í•  ë -->
        </form>
    </div>
</div>
{% endif %}

<!-- íˆ¬í‘œ ëª©ë¡ -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">íˆ¬í‘œ ëª©ë¡</h5>
    </div>
    <div class="card-body">
        {% if polls %}
            <div class="list-group" id="pollsList">
                {% for poll in polls %}
                <a href="{{ url_for('poll_view', poll_id=poll.id) }}" 
                   class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ poll.question }}</h6>
                        <small class="text-muted">{{ poll.created_at.strftime('%m/%d %H:%M') }}</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                    {% if poll.is_active %}
                        <span class="badge bg-success">ì§„í–‰ì¤‘</span>
                    {% else %}
                        <span class="badge bg-secondary">ì¢…ë£Œë¨</span>
                    {% endif %}
                    <form method="POST" action="{{ url_for('delete_poll', poll_id=poll.id) }}" 
                        onsubmit="return confirm('{{ poll.name }} íˆ¬í‘œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')">
                        <button type="submit" class="btn btn-danger btn-sm">ì‚­ì œ</button>
                    </form>
                    </div>
                </a>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">ì•„ì§ ìƒì„±ëœ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>
</div>


<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    
    // í´ë˜ìŠ¤ë£¸ ì…ì¥
    socket.emit('join', {classroom_id: {{ classroom.id }}});
    
    // ìƒˆ íˆ¬í‘œ ì•Œë¦¼
    socket.on('new_poll', function(data) {
        // íˆ¬í‘œê°€ ìƒì„±ë˜ë©´ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•˜ê¸° ìœ„í•´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
        location.reload(); 
    });
    
    // =========================================================
    // êµìˆ˜ì ì „ìš©: íˆ¬í‘œ ìƒì„± í¼ ë¡œì§ (ìœ íš¨ì„± ê²€ì‚¬ ë° ì˜µì…˜ ê´€ë¦¬)
    // =========================================================
    {% if current_user.role == "professor" %}
    
    // í˜„ì¬ ëˆŒë¦° ë²„íŠ¼ì˜ action_typeì„ ì €ì¥í•  ë³€ìˆ˜
    let currentActionType = '';

    // í¼ ì œì¶œ ì „, ì–´ë–¤ ë²„íŠ¼ì´ ëˆŒë ¸ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ
    document.getElementById('pollForm').addEventListener('click', function(e) {
        if (e.target.name === 'action_type') {
            currentActionType = e.target.value;
        }
    });

    // í¼ ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ (onsubmitì—ì„œ í˜¸ì¶œë¨)
    function validateForm(event) {
        if (currentActionType === 'final') {
            // 1. 'ìµœì¢… ì œì¶œ' (final) ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ: ì§ˆë¬¸ê³¼ ì„ íƒì§€ ìœ íš¨ì„± ê²€ì‚¬
            
            const questionInput = document.getElementById('question');
            if (questionInput.value.trim() === '') {
                alert('ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                questionInput.focus();
                return false;
            }

            const optionInputs = document.querySelectorAll('#optionsContainer input[name="options[]"]');
            let allOptionsFilled = true;
            // ë¹ˆ ì˜µì…˜ í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
            optionInputs.forEach(input => {
                if (input.value.trim() === '') {
                    allOptionsFilled = false;
                    input.focus();
                }
            });

            if (!allOptionsFilled) {
                alert('ëª¨ë“  ì„ íƒì§€ ë‚´ìš©ì„ ì±„ì›Œì£¼ì„¸ìš”.');
                return false;
            }
            // ëª¨ë“  í•„ë“œê°€ ì±„ì›Œì ¸ ìˆìœ¼ë©´ ì œì¶œ í—ˆìš©
            return true; 
            
        } else if (currentActionType === 'create') {
            // 2. 'AI ìƒì„±' (create) ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ: ì£¼ì œ(topic) ìœ íš¨ì„± ê²€ì‚¬

            const topicInput = document.getElementById('topic');
            if (topicInput.value.trim() === '') {
                alert('AI ìƒì„± ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                topicInput.focus();
                return false;
            }
            // ì£¼ì œê°€ ì±„ì›Œì ¸ ìˆìœ¼ë©´ ì œì¶œ í—ˆìš© (AI ìƒì„± ìš”ì²­)
            return true;
            
        } else {
            // ê¸°íƒ€ ì˜ˆì™¸ ìƒí™© ë°©ì§€
            return false;
        }
    }

    // ì˜µì…˜ ì¶”ê°€ ê¸°ëŠ¥
    document.getElementById('addOption').addEventListener('click', function() {
        const container = document.getElementById('optionsContainer');
        const count = container.querySelectorAll('.option-group').length + 1;

        const newOption = document.createElement('div');
        newOption.className = 'input-group mb-2 option-group';
        newOption.innerHTML = `
            <span class="input-group-text">${count}</span>
            <input type="text" class="form-control" name="options[]" placeholder="ì„ íƒì§€ ${count}">
            <button type="button" class="btn btn-outline-danger remove-option" onclick="removeOption(this)">X</button>
        `;
        container.appendChild(newOption);
        updateOptionIndices();
    });

    // ì˜µì…˜ ì œê±° ê¸°ëŠ¥
    function removeOption(button) {
        // ìµœì†Œ 2ê°œ ì˜µì…˜ ìœ ì§€ë¥¼ ìœ„í•´ ê·¸ë£¹ ê°œìˆ˜ í™•ì¸
        const container = document.getElementById('optionsContainer');
        const groups = container.querySelectorAll('.option-group');
        if (groups.length <= 2) {
            alert('íˆ¬í‘œì—ëŠ” ìµœì†Œ 2ê°œì˜ ì„ íƒì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        
        const group = button.closest('.option-group');
        group.remove();
        updateOptionIndices();
    }
    
    // ì˜µì…˜ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ ë° ìµœì†Œ 2ê°œ ìœ ì§€ ë¡œì§
    function updateOptionIndices() {
        const container = document.getElementById('optionsContainer');
        let groups = container.querySelectorAll('.option-group');
        
        // --- ìµœì†Œ 2ê°œ ì˜µì…˜ ë³´ì¥ ë¡œì§ (AI ìƒì„± í›„ ì˜µì…˜ì´ ë¶€ì¡±í•  ê²½ìš° ëŒ€ë¹„) ---
        while (groups.length < 2) {
             const newOption = document.createElement('div');
             newOption.className = 'input-group mb-2 option-group';
             newOption.innerHTML = `
                 <span class="input-group-text">${groups.length + 1}</span>
                 <input type="text" class="form-control" name="options[]" placeholder="ì„ íƒì§€ ${groups.length + 1}">
                 <button type="button" class="btn btn-outline-danger remove-option" onclick="removeOption(this)">X</button>
             `;
             container.appendChild(newOption);
             groups = container.querySelectorAll('.option-group'); // groups ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }
        // ------------------------------------------------------------------

        groups.forEach((group, index) => {
            group.querySelector('.input-group-text').textContent = index + 1;
            
            // 1, 2ë²ˆ ì˜µì…˜ì€ ì œê±° ë²„íŠ¼ ìˆ¨ê¸°ê¸° (í•„ìˆ˜ 2ê°œ ìœ ì§€)
            const removeBtn = group.querySelector('.remove-option');
            if (removeBtn) {
                if (index < 2) {
                    removeBtn.style.display = 'none';
                } else {
                    removeBtn.style.display = 'flex'; // flexë¡œ ë³´ì—¬ì£¼ê¸°
                }
            }
            // inputì˜ required ì†ì„±ì€ JSì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œê±°
            group.querySelector('input').removeAttribute('required'); 
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ë±ìŠ¤ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    document.addEventListener('DOMContentLoaded', function() {
        updateOptionIndices();
    });
    {% endif %}
</script>
{% endblock %}
